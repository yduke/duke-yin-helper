name: Release on plugin version change

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write  # âœ… å…è®¸åˆ›å»º tag/release

jobs:
  release:
    runs-on: ubuntu-latest

    env:
      PLUGIN_MAIN_FILE: duke-yin-helper.php  # ðŸ‘ˆ è¯·æ”¹æˆä½ æ’ä»¶çš„ä¸»æ–‡ä»¶å

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ä¿ç•™å®Œæ•´ commit åŽ†å²

      - name: Get previous commit hash
        id: prev
        run: |
          echo "prev_commit=$(git rev-parse HEAD^)" >> $GITHUB_ENV

      - name: Extract current version from plugin main file
        id: current_version
        run: |
          version=$(grep -E '^(Version:|ç‰ˆæœ¬ï¼š)' "${{ env.PLUGIN_MAIN_FILE }}" | sed 's/.*[:ï¼š] *//')
          if [ -z "$version" ]; then
            echo "âŒ æœªèƒ½åœ¨æ’ä»¶ä¸»æ–‡ä»¶ä¸­æ‰¾åˆ°ç‰ˆæœ¬å·"
            exit 1
          fi
          echo "current_version=$version" >> $GITHUB_ENV
          echo "å½“å‰ç‰ˆæœ¬: $version"

      - name: Extract previous version from last commit
        id: prev_version
        run: |
          git show ${{ env.prev_commit }}:${{ env.PLUGIN_MAIN_FILE }} > old_plugin.php || true
          version=$(grep -E '^(Version:|ç‰ˆæœ¬ï¼š)' old_plugin.php | sed 's/.*[:ï¼š] *//')
          echo "prev_version=$version" >> $GITHUB_ENV
          echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: $version"

      - name: Compare versions
        id: compare
        run: |
          if [ "${{ env.current_version }}" != "${{ env.prev_version }}" ]; then
            echo "version_changed=true" >> $GITHUB_ENV
            echo "ðŸ”„ ç‰ˆæœ¬å˜åŒ–: ${{ env.prev_version }} â†’ ${{ env.current_version }}"
          else
            echo "version_changed=false" >> $GITHUB_ENV
            echo "â„¹ï¸ ç‰ˆæœ¬æœªå˜åŒ–ï¼Œæ— éœ€å‘å¸ƒ"
          fi

      - name: Stop if version not changed
        if: env.version_changed == 'false'
        run: exit 0

      - name: Check if tag already exists
        id: tag_check
        run: |
          if git rev-parse "v${{ env.current_version }}" >/dev/null 2>&1; then
            echo "tag_exists=true" >> $GITHUB_ENV
            echo "âš ï¸ Tag v${{ env.current_version }} å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
          else
            echo "tag_exists=false" >> $GITHUB_ENV
          fi

      - name: Stop if tag already exists
        if: env.tag_exists == 'true'
        run: exit 0

      - name: Create ZIP package (with .releaseignore)
        run: |
          ZIP_FILE="${{ github.event.repository.name }}-${{ env.current_version }}.zip"
          EXCLUDE_ARGS="-x '*.git*' '.github/*'"

          if [ -f ".releaseignore" ]; then
            echo "ðŸ§¾ ä½¿ç”¨ .releaseignore è¿‡æ»¤ä»¥ä¸‹å†…å®¹ï¼š"
            while IFS= read -r line; do
              if [ -n "$line" ] && [[ ! "$line" =~ ^# ]]; then
                echo "  - $line"
                EXCLUDE_ARGS="$EXCLUDE_ARGS '$line'"
              fi
            done < .releaseignore
          else
            echo "âš ï¸ æœªæ‰¾åˆ° .releaseignoreï¼Œä½¿ç”¨é»˜è®¤æŽ’é™¤è§„åˆ™ã€‚"
          fi

          eval zip -r "$ZIP_FILE" . $EXCLUDE_ARGS
          echo "âœ… æ‰“åŒ…å®Œæˆï¼š$ZIP_FILE"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.current_version }}
          name: "Plugin Release v${{ env.current_version }}"
          body: |
            ðŸŽ‰ WordPress æ’ä»¶è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬ v${{ env.current_version }}
            ðŸ”– Commit: ${{ github.sha }}
          files: ${{ github.event.repository.name }}-${{ env.current_version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
